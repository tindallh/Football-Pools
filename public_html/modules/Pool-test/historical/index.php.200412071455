<?php
/*****************************************************************************/
/* Football Pool module for PHP-Nuke                                         */
/*   written by: Henry B. Tindall, Jr.                                       */
/*   version 1.01                                                            */
/*   first written: 15 Aug 2004                                              */
/*   last modified: 28 Nov 2004                                              */
/*****************************************************************************/

# ob_start('ob_gzhandler');

if (!eregi("modules.php", $_SERVER['SCRIPT_NAME'])) {
    die ("You can't access this file directly...");
}

require_once("mainfile.php");
$module_name = basename(dirname(__FILE__));
get_lang($module_name);
if (is_user($user)) {
	cookiedecode($user);
	$uname = $cookie[1];
	$result = $db->sql_query("SELECT user_id FROM ".$user_prefix."_users WHERE username='$uname'");
	$row = $db->sql_fetchrow($result);
	$user_id = intval($row[user_id]);
}
/*  A few variables we use later on....       */
$columns = 8;

#$pagetitle = "- The Pools";
include ('header.php');
$today_date = date("Y-m-d");
$disp_date = date("l, j F, Y");
#echo "<center>Today's Date: $disp_date ";
if (isset($weekID)) {
	$weekID = intval($weekID);
} else {
	$result = $db->sql_query("SELECT week,date,time FROM ".$prefix."_games where date >= '$today_date' order by date, time limit 1");
	$object = sql_fetch_object($result, $dbi);
	if(is_object($object)) {
		$weekID = $object->week;
		$weekID = intval($weekID);
		$date = $object->date;
		$time = $object->time;
		$lastweek = $weekID-1;
		$lastweek = intval($lastweek);
		list($y,$m,$d) = explode("-",$date);
		$date = date("l j F, Y", mktime(0,0,0,$m,$d,$y));
		echo "The next game is at $time, $date!<br>\n";
	}	else {
		$result = $db->sql_query("SELECT week,date FROM ".$prefix."_games order by week DESC limit 1");
		$object = sql_fetch_object($result, $dbi);
		if(is_object($object)) {
			$weekID = $object->week;
			$weekID = intval($weekID);
			$lastweek=$weekID;
			$sweekID = $weekID;
		}
		$seasonover = 1;
		echo "<center><font size=+5>Sorry, the season is over.  Join us on the forums, or check out the all the results.</font></center>";
	}
}
$result_check = sql_query("SELECT home_score, visitor_score, week FROM ".$prefix."_games WHERE week = '$weekID'", $dbi);
while ($row = $db->sql_fetchrow($result_check)) {
	$h = intval($row['home_score']);
	$v = intval($row['visitor_score']);
	$g = intval($row['week']);
	if ($h > 0 || $v >0) { $results_present = 1; }
}
if ($results_present == 1) {
	$lrweek = $weekID;
} else {
	$lrweek = $weekID-1;
}
$lastweek=$lrweek-1;
if ($op == "MakePicks") {
	DisplayWeek($weekID);
} elseif ($op == "ScoresLast") {
	DisplayWeek($lastweek);
} elseif ($op == "SavePicks") {
	SavePicks();
} elseif ($op == "WinnersWeek") {
	WinnersWeek($sweekID);
} elseif ($op == "WinnersAll") {
	WinnersAll($weekID);
} elseif ($op == "ShowAllPicks") {
	ShowAllPicks($weekID,$start_user);
} elseif ($op == "DisplayWeek") {
	DisplayWeek($sweekID);
} elseif ($op == "Trivia") {
	Trivia($weekID);
} elseif ($op == "GraphMe") {
	GraphMe($graphuser);
} else {
	Schedule();
}

if (!($op == "MakePicks" || ($op == "DisplayWeek" && $sweekID == $weekID))) { $boxContent .= "<font class=\"content\"><a href=\"modules.php?name=$module_name&amp;op=MakePicks\"><b><i>Make my Picks !</i></b></a></font><br>\n";}
if ($op != "ShowAllPicks") { $boxContent .= "<font class=\"content\"><a href=\"modules.php?name=$module_name&amp;op=ShowAllPicks&amp;weekID=$weekID&amp;start_user=1\"><b>Everyone's Picks</b></a></font><br>\n";}
if ($op != "ShowScores" && $sweekID > 0) { $boxContent .= "<font class=\"content\"><a href=\"modules.php?name=$module_name&amp;op=DisplayWeek&amp;sweekID=$lastweek\"><b>Last Week's Scores</b></a></font><br>\n";}
if ($op != "Schedule") { $boxContent .= "<font class=\"content\"><a href=\"modules.php?name=$module_name&amp;op=Schedule\"><b>Full Schedule</b></a></font><br>\n";}
$boxContent .= "<font class=\"content\"><a href=\"modules.php?name=$module_name&amp;op=WinnersWeek&amp;sweekID=$lrweek\"><b>This Week's winners</b></a></font><br>\n";
$boxContent .= "<font class=\"content\"><a href=\"modules.php?name=$module_name&amp;op=WinnersWeek&amp;sweekID=$lastweek\"><b>Last Week's winners</b></a></font><br>\n";
if ($op != "WinnersAll") { $boxContent .= "<font class=\"content\"><a href=\"modules.php?name=$module_name&amp;op=WinnersAll\"><b>Overall winners</b></a></font><br>\n";}
if ($op != "Trivia") { $boxContent .= "<font class=\"content\"><a href=\"modules.php?name=$module_name&amp;op=Trivia\"><b>Trivial Statistics</b></a></font><br>\n";}
if ($op != "GraphMe") { $boxContent .= "<font class=\"content\"><a href=\"modules.php?name=$module_name&amp;op=GraphMe\"><b>Graph My results</b></a></font><br>\n";}
if ($op) { $boxContent .= "<br><font class=\"content\"><a href=\"modules.php?name=$module_name\"><b>Go to main Pool page</b></a></font><br>\n";}
themecenterbox($boxTitle, $boxContent);

include ('footer.php');

/*********************************************************/
/* Functions                                             */
/*********************************************************/

function Schedule() {
	global $weekID, $lastweek, $boxTitle, $boxContent, $user, $user_id, $uname, $cookie, $prefix, $dbi, $module_name, $db;
	$boxTitle = "Schedule";
	$boxContent .= "<center><table border=\"0\" cellpadding=\"4\">";
	$result = $db->sql_query("SELECT visitor_score, home_score, week FROM ".$prefix."_games ORDER BY week, date,time");
	while ($row = $db->sql_fetchrow($result)) {
		if ($row['visitor_score'] >0 || $row['home_score'] >0) { $finished_games[$row['week']] = 1; }
	}
	$result = $db->sql_query("SELECT week,date FROM ".$prefix."_games ORDER by week, date");
	while ($row = $db->sql_fetchrow($result)) {
		$f_week = $row['week'];
		if (!($gcount[$f_week])) { $f_date[$f_week] = $row['date']; }
		$gcount[$f_week]++;
	}
	foreach ($gcount as $f_week => $count) {
		if ($f_week == $weekID) { 
			$boxContent .= "<tr><td><a href=\"modules.php?name=$module_name&amp;op=DisplayWeek&amp;sweekID=".$f_week;
			$boxContent .= "\"><b>Week $f_week</b></a></td><td align=\"right\">$gcount[$f_week] games, first game on $f_date[$f_week]</td>";
		} else {
			$boxContent .= "<tr><td><a href=\"modules.php?name=$module_name&amp;op=DisplayWeek&amp;sweekID=".$f_week;
			$boxContent .= "\">Week $f_week</a></td><td align=\"right\">$gcount[$f_week] games, first game on $f_date[$f_week]</td>";
		}
		if ($f_week <= $weekID) {
			$boxContent .= "<td><a href=\"modules.php?name=$module_name&amp;op=ShowAllPicks&amp;weekID=".$f_week;
			$boxContent .= "&amp;start_user=1\">Show Picks</a></td>";
		}
		if ($finished_games[$f_week] == 1) { $boxContent .= "<td><a href=\"modules.php?name=$module_name&amp;op=WinnersWeek&amp;sweekID=".$f_week."\">Winners</a></td>"; }
		$boxContent .= "</tr>\n";
	}
	$boxContent .= "</table></center><br><br>\n";
}

function SavePicks() {
	global $weekID, $lastweek, $boxTitle, $boxContent, $user, $user_id, $uname, $cookie, $prefix, $dbi, $module_name, $db;
	$today_date = date("Y-m-d");
	$now_time = date("Hi");
	if (is_user($user)) {
		getusrinfo($user);
		cookiedecode($user);
	}
	$boxTitle = "$uname's week $weekID Picks Submission";
	$result_b = sql_query("SELECT game, pick FROM ".$prefix."_picks WHERE week='$weekID' AND user_id = '$user_id' order by game", $dbi);
	while ($row = $db->sql_fetchrow($result_b)) {
		$db_game = intval($row['game']);
		$db_pick[$db_game] = $row['pick'];
	}
	$count=0;
	$result = $db->sql_query("SELECT team_id, team_name from ".$prefix."_teams", $dbi);
	while ($row = $db->sql_fetchrow($result)) {
		$team_id = $row['team_id'];
		$team_name[$team_id] = $row['team_name'];
	}
	$result = $db->sql_query("SELECT date, time, home, home_score, visitor, visitor_score, home_spread, game FROM ".$prefix."_games WHERE week='$weekID' ORDER by date,time, game", $dbi);
	while ($row = $db->sql_fetchrow($result)) {
		$count++;
		$game = intval($row['game']);
		$date[$game] = $row['date'];
		$time[$game] = $row['time'];
		$day = date("l", strtotime($date[$game]));
		$gid[$game] = $game;
		$h_id = $row['home'];
		$home[$game] = $team_name[$h_id];
		$v_id = $row['visitor'];
		$visitor[$game] = $team_name[$v_id];
		$home_spread[$game] = $row['home_spread'];
	}
	foreach ($gid as $game) {
		$pickval[$game] = $_POST[$game];
		/* here's a handy tool */
		(($pickval[$game] == "home") ? $choice = $home[$game] : $choice = $visitor[$game] );
		(($pickval[$game] == "home") ? $nonchoice = $visitor[$game] : $nonchoice = $home[$game] );
		if (($date[$game] == $today_date && $time[$game] > $now_time) || ($date[$game] > $today_date)) {
			if (($pickval[$game] == "home" ) || ($pickval[$game] == "visitor" )) {
				$boxContent .= "<b>$choice</b> over <b>$nonchoice</b>";
				if ((($db_pick[$game] == "home") || ($db_pick[$game] == "visitor")) && ($db_pick[$game] != $pickval[$game])) {
					$update = $db->sql_query("UPDATE ".$prefix."_picks SET pick = '$pickval[$game]' WHERE (user_id = '$user_id' AND week = '$weekID' AND game = '$game')", $dbi);
					$boxContent .= " (changed)<br>\n";
				} elseif (($db_pick[$game] != "home") && ($db_pick[$game] != "visitor")) {
					$insert = $db->sql_query("INSERT INTO ".$prefix."_picks (user_ID, week, game, pick) VALUES ('$user_id', '$weekID', '$game', '$pickval[$game]')", $dbi);
					$boxContent .= " (added)<br>\n";
				} else {
					$boxContent .= "<br>\n";
				}
			}
		} else {
			# Fix !  add the option to not print anything if the game is already over.
			
			$boxContent .= "<i>Sorry, you're too late to add/change the pick for $visitor[$game] at $home[$game].</i><br>\n";
		}
	}
	$boxContent .= "<br>Thanks for the picks, $uname.<br>";
	$boxContent .= "If you change your mind, you can ";
	$boxContent .= "go back and change any of your picks up until the start of that particular game...<br>";
	$boxContent .= "You'll see your old picks already filled in on the form if you go back and refresh it.<br><br>\n";
}

function WinnersWeek($sweekID) {
	global $user_prefix, $lastweek, $weekID, $boxTitle, $boxContent, $user, $user_id, $uname, $cookie, $prefix, $dbi, $module_name, $db;
	$numweeks = 0;
	$total_games = 0;
	$result_b = sql_query("SELECT user_id, game, pick FROM ".$prefix."_picks WHERE week='$sweekID'", $dbi);
	while ($row = $db->sql_fetchrow($result_b)) {
		$uid = intval($row['user_id']);
		$db_game = intval($row['game']);
		$db_pick[$uid][$db_game] = $row['pick'];
		$numweeks++;
	}
	if ($numweeks > 0) {
		$result = sql_query("SELECT user_id, username FROM ".$user_prefix."_users WHERE user_id > 1 ORDER BY user_id", $dbi);
		while ($row = $db->sql_fetchrow($result)) {
			$db_id = intval($row['user_id']);
			$db_user[$db_id] = $row['username'];
			$db_uid[$db_user[$db_id]] = $db_id;
		}
		$gameresults = sql_query("SELECT home_score, visitor_score, home_spread, game FROM ".$prefix."_games WHERE week='$sweekID' ORDER by date,game", $dbi);
		while ($row = $db->sql_fetchrow($gameresults)) {
			$total_games++;
			$g_game = intval($row['game']);
			$w_game[$g_game] = $g_game;
			$g_home_score = $row['home_score'];
			$g_visitor_score = $row['visitor_score'];
			$g_home_spread = $row['home_spread'];
			if (( $g_home_score > 0 ) or ($g_visitor_score > 0)) {
				$g_result = ($g_home_score - $g_home_spread) - $g_visitor_score;
			} else {
				$g_result = 0;
			}
			if ($g_result > 0) {
				$g_winner[$weekID][$g_game] = "home";
			} elseif ($g_result < 0) {
				$g_winner[$weekID][$g_game] = "visitor";
			} else {
				$g_winner[$weekID][$g_game] = "push";
			}
		}
		foreach ($db_uid as $usernum) {
			foreach ($w_game as $g_num) {
				if (( $db_pick[$usernum][$g_num] == "home" ) || ( $db_pick[$usernum][$g_num] == "visitor" )) {
					$games_picked[$usernum]++;
					if ($g_winner[$weekID][$g_num] == $db_pick[$usernum][$g_num]) {
						$right[$weekID][$usernum]++;
					} elseif ($g_winner[$weekID][$g_num] == "push") {
						$push[$weekID][$usernum]++;
					} else {
						$wrong[$weekID][$usernum]++;
					}
				}
			}
			if (($right[$weekID][$usernum] + $wrong[$weekID][$usernum]) > 0) {
				$pct[$usernum] = $right[$weekID][$usernum] / ($right[$weekID][$usernum] + $wrong[$weekID][$usernum]);
			} else {
			  $pct[$usernum] = 0;
			 }
			if (!($right[$weekID][$usernum])) { $right[$weekID][$usernum] = 0; }
			if (!($wrong[$weekID][$usernum])) { $wrong[$weekID][$usernum] = 0; }
		}
		arsort($pct);
		$i = 1;
		foreach ($pct as $picker => $pick_pct ) {
			if ($total_games - ($games_picked[$picker]*10) < 0) {
				if ($i == 1) {
					$bigwinner = $db_user[$picker];
					$bigpct = strval(number_format($pick_pct, 3));
					$mult = "";
				} else {
					if (strval(number_format($pick_pct, 3)) === $bigpct) {
						$bigwinner .= ", ".$db_user[$picker];
						$mult = "s";
					}
				}	
				$i++;
			} else {
				unset ($pct[$picker]);
			}
		}
		$boxContent .= "<h3>Week $sweekID's big winner".$mult.":</h3><h2>$bigwinner</h2><h3>with a percentage of $bigpct !</h3>\n";
		$boxContent .= "<table>\n";
		$boxContent .= "<tr><td></td><td><b>record</b></td><td><b>percentage</b></td></tr>\n";
		foreach ($pct as $picker => $pick_pct ) {
			$real_user = $db_user[$picker];
			$real_uid = $db_uid[$real_user];
			$boxContent .= "<tr><td><b><a href=\"modules.php?name=Private_Messages&amp;file=index&amp;mode=post&amp;u=".$real_uid."\">".$db_user[$picker]."</a></b></td>";
			$boxContent .= "<td align=\"center\">".$right[$weekID][$picker];
			$boxContent .= " - ".$wrong[$weekID][$picker]."</td><td align=\"center\">".number_format($pick_pct, 3)."</td></tr>\n";
		}
		$boxContent .= "</table><br>\n";
		$boxContent .= "<i>You must have picked at least 10% of the available games for the week to be ";
		$boxContent .= "included in the leaders.</i><br><br>";
	} else {
		$boxContent .= "<h4>Sorry, There are no results to display yet.  Check back next week....</h4>\n";
	}
}

function WinnersAll($weekID) {
	global $user_prefix, $weekID, $lastweek, $boxTitle, $boxContent, $user, $user_id, $uname, $cookie, $prefix, $dbi, $module_name, $db;
	$total_games=0;
	$numweeks = 0;
	$counting = sql_query("SELECT count(*) 'count' FROM ".$user_prefix."_games", $dbi);
	while ($row = $db->sql_fetchrow($counting)) {
		$gamecount = intval($row['count']);
	}
	$result_b = sql_query("SELECT user_id, game, pick, week FROM ".$prefix."_picks WHERE week <= $weekID", $dbi);
	while ($row = $db->sql_fetchrow($result_b)) {
		$db_week = intval($row['week']);
		$uid = intval($row['user_id']);
		$db_game = intval($row['game']);
		$db_pick[$db_week][$uid][$db_game] = $row['pick'];
		$numweeks++;
	}
	if ($numweeks > 0) {
		$result = sql_query("SELECT user_id, username FROM ".$user_prefix."_users WHERE user_id > 1 ORDER BY user_id", $dbi);
		while ($row = $db->sql_fetchrow($result)) {
			$db_id = intval($row['user_id']);
			$db_user[$db_id] = $row['username'];
			$db_uid[$db_user[$db_id]] = $db_id;
		}
		$result_check = sql_query("SELECT home_score, visitor_score, week FROM ".$prefix."_games WHERE week = '$weekID'", $dbi);
		while ($row = $db->sql_fetchrow($result_check)) {
			$h = intval($row['home_score']);
			$v = intval($row['visitor_score']);
			$g = intval($row['week']);
			if ($h > 0 || $v >0) { $results_present = 1; }
		}
		if ($results_present == 1) {
			$lrweek = $weekID;
		} else {
			$lrweek = $weekID-1;
		}
		$thismonth = $lrweek - 4;
		$gameresults = sql_query("SELECT home_score, visitor_score, home_spread, week, game FROM ".$prefix."_games WHERE week <= '$lrweek' ORDER by week, date, game", $dbi);
		while ($row = $db->sql_fetchrow($gameresults)) {
			$total_games++;
			$g_week = intval($row['week']);
			$r_week[$g_week] = $g_week;
			$g_game = intval($row['game']);
			$w_game[$g_game] = $g_game;
			$g_home_score = $row['home_score'];
			$g_visitor_score = $row['visitor_score'];
			$g_home_spread = $row['home_spread'];
			if (( $g_home_score > 0 ) or ($g_visitor_score > 0)) {
				$g_result = ($g_home_score - $g_visitor_score) - $g_home_spread;
			} else {
				$g_result = 0;
			}
			if ($g_result > 0) {
				$g_winner[$g_week][$g_game] = "home";
			} elseif ($g_result < 0) {
				$g_winner[$g_week][$g_game] = "visitor";
			} else {
				$g_winner[$g_week][$g_game] = "push";
			}
		}
		foreach ($db_uid as $usernum) {
			arsort ($r_week);
			foreach ($r_week as $rweek) {
				foreach ($w_game as $g_num) {
					if (( $db_pick[$rweek][$usernum][$g_num] == "home" ) || ( $db_pick[$rweek][$usernum][$g_num] == "visitor" )) {
						$games_picked[$usernum]++;
						if ($g_winner[$rweek][$g_num] == $db_pick[$rweek][$usernum][$g_num]) {
							$right[$rweek][$usernum]++;
							$t_right[$usernum]++;
						} elseif ($g_winner[$rweek][$g_num] == "push") {
							$push[$rweek][$usernum]++;
						} else {
							$wrong[$rweek][$usernum]++;
							$t_wrong[$usernum]++;
						}
					}
				}
				if (!($right[$rweek][$usernum])) { $right[$rweek][$usernum] = 0; }
				if (!($wrong[$rweek][$usernum])) { $wrong[$rweek][$usernum] = 0; }
			}
			if (!($t_right[$usernum])) { $t_right[$usernum] = 0; }
			if (!($t_wrong[$usernum])) { $t_wrong[$usernum] = 0; }
			if (($t_right[$usernum] + $t_wrong[$usernum]) > 0) {
				$pct[$usernum] = $t_right[$usernum] / ($t_right[$usernum] + $t_wrong[$usernum]);
			} else {
			  $pct[$usernum] = 0;
			}
		}
		arsort($pct);
		$i = 1;
		$rank=1;
		$t_rank=1;
		foreach ($pct as $picker => $pick_pct ) {
			if ($total_games - ($games_picked[$picker]*10) < 0) {
				if ($i == 1) {
					$ranking[$picker]=$rank;
					$bigwinner = $db_user[$picker];
					$bigpct = number_format($pick_pct, 3);
					(($seasonover == 1 ) ? $descript = "winner" : $descript = "leader");
					$verb = "is";
				} else {
					if (strval(number_format($pick_pct, 3)) === $bigpct) {
						$bigwinner .= ", ".$db_user[$picker];
						(($seasonover == 1 ) ? $descript = "winners" : $descript = "leaders");
						$verb = "are";
					}
					if ($pick_pct == $prev_pct) {
						$ranking[$picker] = $rank;
						$t_rank++;
					} else {
						$rank += $t_rank;
						$t_rank = 1;
						$ranking[$picker] = $rank;
					}
				}	
				$i++;
				$prev_pct=$pick_pct;
			} else {
				unset ($pct[$picker]);
			}
		}
		$boxContent .= "<h2>The overall ".$descript." through $total_games of $gamecount games ".$verb." $bigwinner, with a percentage of $bigpct !</h2>\n";
		$boxContent .= "<table>\n";
		$boxContent .= "<tr><td><b>Rank</b>&nbsp;&nbsp;</td><td></td><td align=\"center\"><b>Overall<br>record</b></td><td align=\"center\"><b>Overall<br>percentage</b></td>";
		foreach ($r_week as $rweek) {
			$boxContent .= "<td align=\"center\"><a href=\"modules.php?name=$module_name&amp;op=WinnersWeek&amp;sweekID=".$rweek."\">";
			$boxContent .= "week<br>$rweek</a></td>";
		}
		$boxContent .= "</tr>\n";
		foreach ($pct as $picker => $pick_pct ) {
			$real_user = $db_user[$picker];
			$real_uid = $db_uid[$real_user];
			$boxContent .= "<tr><td align=\"right\"><b>$ranking[$picker]</b>&nbsp;&nbsp;&nbsp;</td>";
			$boxContent .= "<td nowrap><a href=\"modules.php?name=$module_name&amp;op=GraphMe&amp;graphuser=".$real_uid."\"><img src=\"images/poollogos/graph.png\" alt=\"Show Graph of ".$db_user[$picker]."'s picks\"></a>&nbsp;";
			$boxContent .= "<b><a href=\"modules.php?name=Private_Messages&amp;file=index&amp;mode=post&amp;u=".$real_uid."\">".$db_user[$picker]."</a></b>";
			$boxContent .= "</td><td align=\"center\" nowrap>".$t_right[$picker]." - ".$t_wrong[$picker]."</td>";
			$boxContent .= "<td align=\"center\">".number_format($pick_pct, 3)."</td>";
			foreach ($r_week as $rweek) {
				$boxContent .= "<td border=\"1\" align=\"center\">".$right[$rweek][$picker]."-".$wrong[$rweek][$picker]."</td>";
			}
			$boxContent .= "</tr>\n";
		}
		$boxContent .= "</table><br><br>\n";
		$boxContent .= "<i>You must have picked at least 10% of all the games to this point in the season to be ";
		$boxContent .= "included in the overall leaders.</i><br><br>";
	} else {
		$boxContent .= "<h4>Sorry, There are no results to display yet.  Check back next week....</h4>\n";
	}
}

function ShowAllPicks($weekID,$start_user) {
	global $tot_users, $columns, $lastweek, $user_prefix, $weekID, $start_user, $boxTitle, $boxContent, $cookie, $prefix, $dbi, $module_name, $db;
	$hrspan = $columns+3;
	$boxTitle = "Everyone's picks";
	$result = sql_query("SELECT user_id, game, pick FROM ".$prefix."_picks WHERE user_id > 1 AND week='$weekID'", $dbi);
	while ($row = $db->sql_fetchrow($result)) {
		$db_game = intval($row['game']);
		$user = $row['user_id'];
		$pick = $row['pick'];
		if ($pick) { $haspicks[$user] = 1; }
	}
	foreach ($haspicks as $user => $flag) {
		if ($userlist) {
			$userlist .= " or user_id = '".$user."'";
		} else {
			$userlist = "user_id = '".$user."'";
		}
	}
	$sql = "SELECT user_id, username FROM ".$user_prefix."_users WHERE (".$userlist.") ORDER BY user_id";
	$grabusertot = sql_query($sql, $dbi);
	$tot_users = 0;
	while ($row = $db->sql_fetchrow($grabusertot)) {
		$db_id = intval($row['user_id']);
		$db_user[$db_id] = $row['username'];
		$tot_users++;
		$realName[$tot_users] = $row['username'];
		$realID[$tot_users] =  $db_id;
		$userIDX[$db_id] = $tot_users;
	}
	if ($tot_users > $start_user+($columns-1)) {
		$end_user = $start_user+($columns-1);
		$moreusers = "true"; 
	} elseif ($tot_users >= $start_user) {
		$end_user = $tot_users;
		$moreusers = "false";
	}
	$result_b = sql_query("SELECT user_id, game, pick FROM ".$prefix."_picks WHERE week='$weekID'", $dbi);
	while ($row = $db->sql_fetchrow($result_b)) {
		$db_game = intval($row['game']);
		$IDX = $userIDX[intval($row['user_id'])];
		$tpick = $row['pick'];
		$db_pick[$IDX][$db_game] = $tpick;
		if (($tpick == 'home') || ($tpick == 'visitor')) { $haspicks[$IDX] = 1;}
	}
	$result = $db->sql_query("SELECT team_id, team_name from ".$prefix."_teams", $dbi);
	while ($row = $db->sql_fetchrow($result)) {
		$team_id = $row['team_id'];
		$team_name[$team_id] = $row['team_name'];
	}
	$gameresults = sql_query("SELECT home, home_score, home_rank, visitor, visitor_score, visitor_rank, home_spread, game, Title FROM ".$prefix."_games WHERE week = '$weekID' ORDER by date, time, game", $dbi);
	while ($row = $db->sql_fetchrow($gameresults)) {
		$d_gid = intval($row['game']);
		$d_game[$d_gid] = $d_gid;
		$d_title[$d_gid] = $row['Title'];
		$d_h_id = $row['home'];
		$d_home[$d_gid] = $team_name[$d_h_id];
		$d_v_id = $row['visitor'];
		$d_visitor[$d_gid] = $team_name[$d_v_id];
		$d_home_score[$d_gid] = $row['home_score'];
		$d_visitor_score[$d_gid] = $row['visitor_score'];
		$d_home_spread[$d_gid] = $row['home_spread'];
		$home_rank[$d_gid] = $row['home_rank'];
		$visitor_rank[$d_gid] = $row['visitor_rank'];
		(($home_rank[$d_gid]) ? $d_h_rank[$d_gid] = "#".$home_rank[$d_gid]." " : $d_h_rank[$d_gid] = "");
		(($visitor_rank[$d_gid]) ? $d_v_rank[$d_gid] = "#".$visitor_rank[$d_gid]." " : $d_v_rank[$d_gid] = "");
		$g_result[$d_gid] = ($d_home_score[$d_gid] - $d_visitor_score[$d_gid]) - $d_home_spread[$d_gid];
	}
	$boxContent .= "<center>";
	if ($start_user > $columns) {
		$prev_start_user = $start_user-$columns;
		$boxContent .= "<a href=\"modules.php?name=$module_name&amp;op=ShowAllPicks&amp;weekID=$weekID&amp;start_user=$prev_start_user\"><b>Previous $columns Players</b></a>";
	}
	if (($start_user > $columns) &&($moreusers == "true")) {
		$boxContent .= "&nbsp;&nbsp;&nbsp;--&nbsp;&nbsp;&nbsp;";
	}
	if ($moreusers == "true" ) {
		$nstart_user = $start_user+$columns;
		$boxContent .= "<a href=\"modules.php?name=$module_name&amp;op=ShowAllPicks&amp;weekID=$weekID&amp;start_user=$nstart_user\"><b>Next $columns Players</b></a>";
	}
	$boxContent .= "<br><br>";
	$boxContent .= "<table cellpadding=\"2\">\n<tr><td></td><td></td>";
	for ($i = $start_user; $i <= $end_user; $i++) {
		$boxContent .= "<td align=\"center\"><a href=\"modules.php?name=Private_Messages&amp;file=index&amp;mode=post&amp;u=".$realID[$i]."\">".$realName[$i]."</a></td>";
	}
	$boxContent .= "</tr>\n";
	foreach ($d_game as $g_num) {
		if ($d_home_spread[$g_num]) {
			if (!(($d_home_score[$g_num] > 0) || ($d_visitor_score[$g_num] > 0))) { $g_result[$g_num] = 0; }
			if (!($d_title[$g_num] == "")) { $boxContent .= "<tr><td align=\"center\"><b>$d_title[$g_num]</b></td></tr>\n"; }
			$boxContent .= "<tr><td nowrap><center>".$d_v_rank[$g_num].$d_visitor[$g_num]." at<br>";
			$boxContent .= $d_h_rank[$g_num].$d_home[$g_num]." (".$d_home_spread[$g_num].")</center></td>";
			$boxContent .= "<td><b>$d_visitor_score[$g_num]&nbsp;&nbsp;<br>$d_home_score[$g_num]&nbsp;&nbsp;</b></td>";
			for ($i = $start_user; $i <= $end_user; $i++) {
				if (( $db_pick[$i][$g_num] == "home" ) || ( $db_pick[$i][$g_num] == "visitor" )) {
					if ($db_pick[$i][$g_num] == "home") {
						$pick = $d_home[$g_num];
						if ($g_result[$g_num] > 0) { 
							$boxContent .= "<td align=\"center\" valign=\"center\" bgcolor=lightgreen><b>$pick</b></td>";
						} elseif ($g_result[$g_num] < 0) {
							$boxContent .= "<td align=\"center\" valign=\"center\" bgcolor=red><b>$pick</b></td>";
						} elseif ($g_result[$g_num] == 0) {
							if (($d_home_score[$g_num]) > 0 || ($d_visitor_score[$g_num] > 0)) {
								$boxContent .= "<td align=\"center\" valign=\"center\" bgcolor=#bababa>$pick</td>";
							} else {
								$boxContent .= "<td align=\"center\" valign=\"center\">$pick</td>";
							}
						}
					} else {
						$pick = $d_visitor[$g_num];
						if ($g_result[$g_num] < 0) { 
							$boxContent .= "<td align=\"center\" valign=\"center\" bgcolor=lightgreen><b>$pick</b></td>";
						} elseif ($g_result[$g_num] > 0)  {
							$boxContent .= "<td align=\"center\" valign=\"center\" bgcolor=red><b>$pick</b></td>";
						} elseif ($g_result[$g_num] == 0) { 
							if (($d_home_score[$g_num]) > 0 || ($d_visitor_score[$g_num] > 0)) {
								$boxContent .= "<td align=\"center\" valign=\"center\" bgcolor=#bababa>$pick</td>";
							} else {
								$boxContent .= "<td align=\"center\" valign=\"center\">$pick</td>";
							}
						} 
					}
				} else {
					$boxContent .= "<td align=\"center\" valign=\"center\"><i>---</i></td>";
				}
			}
			$boxContent .= "</tr>\n<tr><td colspan=\"$hrspan\"><hr></td></tr>\n";
		}
	}
	$boxContent .= "</table><br><br>\n";
	if ($start_user > $columns) {
		$prev_start_user = $start_user-$columns;
		$boxContent .= "<a href=\"modules.php?name=$module_name&amp;op=ShowAllPicks&amp;weekID=$weekID&amp;start_user=$prev_start_user\"><b>Previous $columns Players</b></a>";
	}
	if (($start_user > $columns) &&($moreusers == "true")) {
		$boxContent .= "&nbsp;&nbsp;&nbsp;--&nbsp;&nbsp;&nbsp;";
	}
	if ($moreusers == "true" ) {
		$start_user = $start_user+$columns;
		$boxContent .= "<a href=\"modules.php?name=$module_name&amp;op=ShowAllPicks&amp;weekID=$weekID&amp;start_user=$start_user\"><b>Next $columns Players</b></a><br>";
	}
	$boxContent .= "</center>\n";
}

function DisplayWeek($sweekID) {
	global $boxTitle, $lastweek, $boxContent, $user, $user_id, $uname, $cookie, $prefix, $dbi, $module_name, $db, $seasonover;
	$today_date = date("Y-m-d");
	$now_time = date("Hi");
	if ($seasonover == 1) {
		$boxContent .= "<h3>Sorry, the season is over.  Come back next fall for more fun...</h3>\n";
	} else {
		$boxTitle = "<h2>$uname's picks - Week $sweekID</h2>";
		$boxContent .= "<form action=\"modules.php?name=$module_name&amp;op=SavePicks\" method=\"post\">";
		$boxContent .= "<input type=\"hidden\" name=\"weekID\" value=\"".$sweekID."\">";
		unset ($db_hi);
		$result_b = sql_query("SELECT game, pick FROM ".$prefix."_picks WHERE week='$sweekID' AND user_id = '$user_id' order by game", $dbi);
		while ($row = $db->sql_fetchrow($result_b)) {
			$db_game = $row['game'];
			$db_pick = $row['pick'];
			$db_hi[$db_game][$db_pick] = true;
		}
		$gamestopick=0;
		$gamesfrozen=0;
		$withoutspreads=0;
		$finishedgames=0;
		$game_count = sql_query("SELECT count(game) count FROM ".$prefix."_games WHERE week='$sweekID' ORDER by date, time, visitor", $dbi);
		while ($row = $db->sql_fetchrow($game_count)) {
			$wk_game_count = $row['count'];
		}
		$result = $db->sql_query("SELECT team_id, team_name from ".$prefix."_teams", $dbi);
		while ($row = $db->sql_fetchrow($result)) {
			$team_id = $row['team_id'];
			$team_name[$team_id] = $row['team_name'];
		}
		$boxContent .= "<table border=\"1\" width=\"100%\">\n\t<tr><td>";
		$result = sql_query("SELECT date, time, home, home_score, visitor, visitor_rank, home_rank, visitor_score, home_spread, game, Title FROM ".$prefix."_games WHERE week='$sweekID' ORDER by date, time, visitor", $dbi);
		while ($row = $db->sql_fetchrow($result)) {
			$recnum++;
			$game = $row['game'];
			$date[$game] = $row['date'];
			$time[$game] = $row['time'];
			$title[$game] = $row['Title'];
			$day = date("l", strtotime($date[$game]));
			$h_id = $row['home'];
			$home = $team_name[$h_id];
			$v_id = $row['visitor'];
			$visitor = $team_name[$v_id];
			$home_score = $row['home_score'];
			$visitor_score = $row['visitor_score'];
			$home_spread = $row['home_spread'];
			$home_rank = $row['home_rank'];
			$visitor_rank = $row['visitor_rank'];
			$g_counter++;
			(($home_rank) ? $d_h_rank = "#".$home_rank." " : $d_h_rank = "");
			(($visitor_rank) ? $d_v_rank = "#".$visitor_rank." " : $d_v_rank = "");
			if (!(($home_score > 0) || ($visitor_score > 0))) {
				if (($date[$game] == $today_date && $time[$game] > $now_time) || ($date[$game] > $today_date)) { 
					if ($home_spread) {
						$gamestopick++ ;
						$boxContent .= "<table cellpadding=\"1\" cellspacing=\"1\">";
						if (!($title[$game] == "")) { $boxContent .= "<tr><td colspan=\"5\" align=\"center\"><b>$title[$game]</b></td></tr>\n"; }
						$boxContent .= "<tr><td valign=\"bottom\">$day,</td><td><input type=\"radio\" name=\"$game\" VALUE=\"visitor\"".($db_hi[$game]['visitor'] ? ' checked' : '')."></td>";
						$boxContent .= "<td><img src=\"/images/poollogos/".$v_id.".gif\"></td>";
						$boxContent .= "<td><font class=\"content\">$d_v_rank$visitor</font></td></tr>\n";
						$boxContent .= "<tr><td align=\"center\" valign=\"top\">$date[$game]<br>$time[$game]</td><td><input type=\"radio\" name=\"$game\" VALUE=\"home\"".($db_hi[$game]['home'] ? ' checked' : '')."></td>";
						$boxContent .= "<td><img src=\"/images/poollogos/".$h_id.".gif\"></td>";
						$boxContent .= "<td><font class=\"content\">at $d_h_rank$home</font></td><td><font class=\"content\"><i>($home_spread)</i></font></td></tr></table>\n";
					} else {
					 	$withoutspreads++ ;
						$boxContent .= "<table cellpadding=\"1\" cellspacing=\"1\">";
						if (!($title[$game] == "")) { $boxContent .= "<tr><td colspan=\"5\" align=\"center\"><b>$title[$game]</b></td></tr>\n"; }
						$boxContent .= "<tr><td valign=\"bottom\">$day,</td><td></td>";
						$boxContent .= "<td><img src=\"/images/poollogos/".$v_id.".gif\"></td>";
						$boxContent .= "<td><font class=\"content\">$visitor</font></td></tr>\n";
						$boxContent .= "<tr><td align=\"center\" valign=\"top\">$date[$game]<br>$time[$game]</td><td></td>";
						$boxContent .= "<td><img src=\"/images/poollogos/".$h_id.".gif\"></td>";
						$boxContent .= "<td><font class=\"content\">at $home</font></td><td></td></tr></table>\n";
					}
				} else {
					$gamesfrozen++ ;
					$boxContent .= "<table cellpadding=\"1\" cellspacing=\"1\">";
					if (!($title[$game] == "")) { $boxContent .= "<tr><td colspan=\"5\" align=\"center\"><b>$title[$game]</b></td></tr>\n"; }
					$boxContent .= "<tr><td valign=\"bottom\">$day,</td><td>".($db_hi[$game]['visitor'] ? "<img src=\"images/poollogos/check.png\">" : '')."</td>";
					$boxContent .= "<td><img src=\"/images/poollogos/".$v_id.".gif\"></td>";
					$boxContent .= "<td><font class=\"content\">$d_v_rank$visitor</font></td></tr>\n";
					$boxContent .= "<tr><td align=\"center\" valign=\"top\">$date[$game]<br>$time[$game]</td><td>".($db_hi[$game]['home'] ? "<img src=\"images/poollogos/check.png\">" : '')."</td>";
					$boxContent .= "<td><img src=\"/images/poollogos/".$h_id.".gif\"></td>";
					$boxContent .= "<td><font class=\"content\">at $d_h_rank$home</font></td><td><font class=\"content\"><i>($home_spread)</i></font></td></tr></table>\n";
				}
			} else {
				$finishedgames++ ;
				$hbh="";
				$heh="";
				$vbh="";
				$veh="";
				$vbgc = "";
				$hbgc = "";
				$g_result = ($home_score - $visitor_score) - ($home_spread);
				if ($g_result > 0) { 
					$hbh="<b>";
					$heh="</b>";
					if ($db_hi[$game]['home']) {
						$hbgc = " bgcolor=lightgreen";
					} elseif ($db_hi[$game]['visitor']) {
						$vbgc = " bgcolor=red";
					}
				} elseif ($g_result < 0) {
					$vbh="<b>";
					$veh="</b>";
					if ($db_hi[$game]['visitor']) {
						$vbgc = " bgcolor=lightgreen";
					} elseif ($db_hi[$game]['home']) {
						$hbgc = " bgcolor=red";
					}
				} elseif ($g_result == 0) {
					$vbgc = " bgcolor=#bababa";
					$hbgc = " bgcolor=#bababa";
				}
				$boxContent .= "<table cellpadding=\"1\" cellspacing=\"1\">";
				if (!($title[$game] == "")) { $boxContent .= "<tr><td colspan=\"5\" align=\"center\"><b>$title[$game]</b></td></tr>\n"; }
				$boxContent .= "<tr><td valign=\"bottom\">$day,</td><td>".$vbh."<font class=\"content\">$visitor_score</font>".$veh."</td>";
				$boxContent .= "<td><img src=\"/images/poollogos/".$v_id.".gif\"></td>";
				$boxContent .= "<td".$vbgc.">".$vbh."<font class=\"content\">$d_v_rank$visitor</font>".$veh."</td></tr>\n";
				$boxContent .= "<tr><td align=\"center\" valign=\"top\">$date[$game]<br>@ $time[$game]</td><td>".$hbh."<font class=\"content\">$home_score</font>".$heh."</td>";
				$boxContent .= "<td><img src=\"/images/poollogos/".$h_id.".gif\"></td>";
				$boxContent .= "<td".$hbgc.">".$hbh."<font class=\"content\">at $d_h_rank$home</font>".$heh."</td><td><font class=\"content\"><i>($home_spread)</i></font></td></tr></table>\n";
			}
			if ($recnum%3 == 0) {
				$boxContent .= "</td></tr>\n<tr><td>";
			} else {
				$boxContent .= "</td>\n<td>\n";
			}
		}
		$boxContent .= "</table></td></tr></table><br><center>\n";
		if ($gamestopick > 0) {
			$boxContent .= "<input type=\"submit\" VALUE=\"Submit\">\n";
			$boxContent .= "</center></form><br>\n";
			$boxContent .= "If you change your mind, you can ";
			$boxContent .= "come back and change any of your picks up until the start of that particular game...<br>";
			$boxContent .= "Once you've saved a choice, it'll be filled in on the form when you bring it up.<br>\n";
		} else {
			$boxContent .= "</center></form><br>\n";
		}
		if ($finishedgames > 0) {
			$boxContent .= "<tr><td colspan=12><i>Winning teams against the spread are in </i><b>bold</b><i>, ";
			$boxContent .= "your picks are highlighted in Green if correct, Red if wrong, and both teams are ";
			$boxContent .= "greyed out in the event of a push.</i></td></tr></table><br><br>\n";
		}
		if ($gamesfrozen == 1) {
			$boxContent .= "$gamesfrozen - One of your games is past the pick deadline, your pick is marked with a \"<img src=\"images/poollogos/check.png\">\".<br><br>\n";
		} elseif ($gamesfrozen > 1) {
			$boxContent .= "Some of your games are past the pick deadline, your picks are marked with a \"<img src=\"images/poollogos/check.png\">\".<br><br>\n";
		}
		if ($withoutspreads > 0) {
			$boxContent .= "As soon as the Spreads are posted, You'll have the chance to pick your team.<br><br>\n";
		}
	}
}

function Trivia($weekID) {
	global $user_prefix, $weekID, $lastweek, $boxTitle, $boxContent, $user, $user_id, $uname, $cookie, $prefix, $dbi, $module_name, $db;
	$today_date = date("Y-m-d");
	$result = sql_query("SELECT date, time, home, home_score, visitor, visitor_rank, home_rank, visitor_score, home_spread, game FROM ".$prefix."_games ORDER by date, time, visitor", $dbi);
	while ($row = $db->sql_fetchrow($result)) {
		$game = $row['game'];
		$date[$game] = $row['date'];
		$time[$game] = $row['time'];
		$day = date("l", strtotime($date[$game]));
		$home = $row['home'];
		$visitor = $row['visitor'];
		$home_score = $row['home_score'];
		$visitor_score = $row['visitor_score'];
		$home_spread = $row['home_spread'];
		$h_rank = $row['home_rank'];
		$v_rank = $row['visitor_rank'];
		$g_result = ($home_score - $visitor_score) - ($home_spread);
		if ($home_score > 0 || $visitor_score > 0) {
			if ($g_result > 0) {
				$h_victory++;
				$wins[$home]++;
				$losses[$visitor]++;
			}
			if ($g_result < 0) {
				$v_victory++;
				$wins[$visitor]++;
				$losses[$home]++;
			}
			if ($g_result == 0) {
				$pushes++;
				$t_pushes[$visitor]++;
				$t_pushes[$home]++;
			}
			$t_v_score += $visitor_score;
			$t_h_score += $home_score;
			$t_h_spread += $home_spread;
			$t_games++;
			if ($h_rank > 0 && $v_rank > 0) {
				$b_ranked_count++;
				if ($v_rank > $h_rank) {
					$b_hhr++;
					if ($g_result > 0) { $b_hhr_win++; }
					if ($g_result < 0) { $b_hhr_loss++; }
					if ($g_result == 0) { $b_hhr_push++; }
				}
				if ($v_rank < $h_rank) {
					$b_vhr++;
					if ($g_result > 0) { $b_vhr_win++; }
					if ($g_result < 0) { $b_vhr_loss++; }
					if ($g_result == 0) { $b_vhr_push++; }
				}
			}
			if (($h_rank > 0 && $v_rank < 1 ) || ($h_rank < 1 && $v_rank > 0)){
				$ranked_count++;
				if (!($h_rank)) {$h_rank=26; }
				if (!($v_rank)) {$v_rank=26; }
				if ($v_rank > $h_rank) {
					$hhr++;
					if ($g_result > 0) { $hhr_win++; }
					if ($g_result < 0) { $hhr_loss++; }
					if ($g_result == 0) { $hhr_push++; }
				}
				if ($v_rank < $h_rank) {
					$vhr++;
					if ($g_result > 0) { $vhr_win++; }
					if ($g_result < 0) { $vhr_loss++; }
					if ($g_result == 0) { $vhr_push++; }
				}
			}
		}
	}
	foreach ($wins as $team => $tw) {
		if (!($t_pushes[$team])) {$t_pushes[$team] = "0";}
		$team_pct[$team] = $tw/($tw+$losses[$team]+$t_pushes[$team]);
	}
	arsort($team_pct);
	$avg_h_score = strval(number_format(($t_h_score / $t_games), 1));
	$avg_v_score = strval(number_format(($t_v_score / $t_games), 1));
	$avg_spread = strval(number_format(($t_h_spread / $t_games), 1));
	$result_b = sql_query("SELECT game, week, pick FROM ".$prefix."_picks order by week, game", $dbi);
	while ($row = $db->sql_fetchrow($result_b)) {
		$db_game = $row['game'];
		$db_pick = $row['pick'];
		$db_week = $row['week'];
		if ($db_pick == 'home') {
			$h_picks[$week]++;
			$t_h_picks++;
		} elseif ($db_pick == 'visitor') {
			$v_picks[$week]++;
			$t_v_picks++;
		}			
	}
	$result = $db->sql_query("SELECT team_id, team_name from ".$prefix."_teams", $dbi);
	while ($row = $db->sql_fetchrow($result)) {
		$team_id = $row['team_id'];
		$team_name[$team_id] = $row['team_name'];
	}
	$t_picks = $t_h_picks + $t_v_picks;
	$h_pct = strval(number_format((($t_h_picks / $t_picks) * 100), 1));
	$v_pct = strval(number_format((($t_v_picks / $t_picks) * 100), 1));
	$boxContent .= "<b>Through all the games so far this year...</b><br><br>\n";
	$boxContent .= "The average score was visitor $avg_v_score, home $avg_h_score.<br>\n";
	$boxContent .= "The average spread for the home team was $avg_spread.<br>\n";
	$boxContent .= "The home team has beat the spread $h_victory times, visitor $v_victory times, and $pushes pushes.<br>\n";
	$boxContent .= "<table border=\"1\"><tr><td>\n";
	$boxContent .= "In the $ranked_count games where only one<br>team was ranked in the top 25:<br>\n";
	$boxContent .= "<table cellpadding=\"2\">\n";
	$boxContent .= "<tr><td align=\"center\">Higher ranked</td><td align=\"center\">Home</td><td align=\"center\">Visitor</td></tr>\n";
	$boxContent .= "<tr><td align=\"center\"><i>beat spread</i></td><td align=\"center\">$hhr_win</td><td align=\"center\">$vhr_win</td></tr>\n";
	$boxContent .= "<tr><td align=\"center\"><i>missed spread</i></td><td align=\"center\">$hhr_loss</td><td align=\"center\">$vhr_loss</td></tr>\n";
	$boxContent .= "<tr><td align=\"center\"><i>pushed</i></td><td align=\"center\">$hhr_push</td><td align=\"center\">$vhr_push</td></tr>\n";
	$boxContent .= "<tr><td align=\"center\"><i>total</i></td><td align=\"center\">$hhr</td><td align=\"center\">$vhr</td></tr>\n";
	$boxContent .= "</table><br>\n";
	$boxContent .= "</td><td>\n";
	$boxContent .= "In the $b_ranked_count games where both<br>teams were ranked in the top 25:<br>\n";
	$boxContent .= "<table cellpadding=\"2\">\n";
	$boxContent .= "<tr><td align=\"center\">Higher ranked</td><td align=\"center\">Home</td><td align=\"center\">Visitor</td></tr>\n";
	$boxContent .= "<tr><td align=\"center\"><i>beat spread</i></td><td align=\"center\">$b_hhr_win</td><td align=\"center\">$b_vhr_win</td></tr>\n";
	$boxContent .= "<tr><td align=\"center\"><i>missed spread</i></td><td align=\"center\">$b_hhr_loss</td><td align=\"center\">$b_vhr_loss</td></tr>\n";
	$boxContent .= "<tr><td align=\"center\"><i>pushed</i></td><td align=\"center\">$b_hhr_push</td><td align=\"center\">$b_vhr_push</td></tr>\n";
	$boxContent .= "<tr><td align=\"center\"><i>total</i></td><td align=\"center\">$b_hhr</td><td align=\"center\">$b_vhr</td></tr>\n";
	$boxContent .= "</table><br>\n";
	$boxContent .= "</td></tr></table>\n";
	$boxContent .= "The pool players picked the home team $h_pct% of the time, visitor $v_pct%.<br><br>\n";
	# Percentage of the group !
	$sql = "SELECT user_id, username FROM ".$user_prefix."_users WHERE user_id > 1 ORDER BY user_id";
	$ures = sql_query($sql, $dbi);
	while ($row = $db->sql_fetchrow($ures)) {
		$db_id = intval($row['user_id']);
		$db_user[$db_id] = $row['username'];
		$db_uid[$db_user[$db_id]] = $db_id;
	}
	$sql = "SELECT week, user_id, game, pick FROM ".$prefix."_picks WHERE week <= $weekID";
	$gres = sql_query($sql, $dbi);
	while ($row = $db->sql_fetchrow($gres)) {
		$all_week = intval($row['week']);
		$all_uid = intval($row['user_id']);
		$all_game = intval($row['game']);
		$allpicks[$all_week][$all_uid][$all_game] = $row['pick'];
		$thispick = $allpicks[$all_week][$all_uid][$all_game];
	}
	$sql = "SELECT home_score, visitor_score, home_spread, week, game FROM ".$prefix."_games WHERE week <= '$weekID' ORDER by week, date, game";
	$gameresults = sql_query($sql, $dbi);
	while ($row = $db->sql_fetchrow($gameresults)) {
		$total_games++;
		$g_week = intval($row['week']);
		$r_week[$g_week] = $g_week;
		$g_game = intval($row['game']);
		$w_game[$g_game] = $g_game;
		$g_home_score = $row['home_score'];
		$g_visitor_score = $row['visitor_score'];
		$g_home_spread = $row['home_spread'];
		if (( $g_home_score > 0 ) or ($g_visitor_score > 0)) {
			$g_result = ($g_home_score - $g_visitor_score) - $g_home_spread;
		} else {
			$g_result = 0;
		}
		if ($g_result > 0) {
			$g_winner[$g_week][$g_game] = "home";
		} elseif ($g_result < 0) {
			$g_winner[$g_week][$g_game] = "visitor";
		}
	}

	foreach ($db_uid as $usernum) {
		arsort ($r_week);
		foreach ($r_week as $rweek) {
			asort($w_game);
			foreach ($w_game as $g_num) {
				$thispick = $allpicks[$rweek][$usernum][$g_num];
				if (( $thispick == "home" ) || ( $thispick == "visitor" )) {
					$winner = $g_winner[$rweek][$g_num];
					if ($g_winner[$rweek][$g_num] == $thispick) {
						$all_right++;
					} else {
						$all_wrong++;
					}
				}
			}
		}
		if (!($all_right)) { $all_right = 0; }
		if (!($all_wrong)) { $all_wrong = 0; }
		if (($all_right + $all_wrong) > 0) {
			$all_pct = $all_right / ($all_right + $all_wrong);
		} else {
		  $all_pct = 0;
		}
	}
	$boxContent .= "<h3>The Aggregate percentage of all pickers is ".number_format($all_pct, 3)." !</h3>\n";
	$boxContent .= "Best/worst teams against the spread...<br>\n";
	$boxContent .= "<table><tr><th>Team</th><th>record</th><th>Percentage</th></tr>\n";
	foreach ($team_pct as $team => $pct) {
		$rank++;
		$boxContent .= "<tr><td>".$team_name[$team]."&nbsp;&nbsp;&nbsp;</td><td>($wins[$team]-$losses[$team]-$t_pushes[$team])</td><td>".number_format($pct, 3)."</td></tr>\n";
	}
	$boxContent .= "</table><br>";
}

function GraphMe($graphuser) {
	global $user_prefix, $weekID, $lastweek, $boxTitle, $boxContent, $user, $user_id, $uname, $cookie, $prefix, $dbi, $module_name, $db;
	if (!($graphuser)) { $graphuser = $user_id; } 
	# Get the mundane out of the way first.
	$xtitle = "Week";
#	$ytitle = "Percentage";
	include ("jpgraph/jpgraph.php");
	include ("jpgraph/jpgraph_line.php");
#	include ("jpgraph/jpgraph_error.php");
	include ("jpgraph/jpgraph_bar.php");
	# Here's where we put in the actual data...
	# l1 is the user, l2 is everyone else.
	# datax is the legend for the x axis.
	$result_b = sql_query("SELECT user_id, game, pick, week FROM ".$prefix."_picks WHERE week <= $weekID", $dbi);
	while ($row = $db->sql_fetchrow($result_b)) {
		$db_week = intval($row['week']);
		$uid = intval($row['user_id']);
		$db_game = intval($row['game']);
		$db_pick[$db_week][$uid][$db_game] = $row['pick'];
		$numweeks++;
	}
	if ($numweeks > 0) {
		$result = sql_query("SELECT user_id, username FROM ".$user_prefix."_users WHERE user_id > 1 ORDER BY user_id", $dbi);
		while ($row = $db->sql_fetchrow($result)) {
			$db_id = intval($row['user_id']);
			$db_user[$db_id] = $row['username'];
			$db_uid[$db_user[$db_id]] = $db_id;
		}
		$result_check = sql_query("SELECT home_score, visitor_score, week FROM ".$prefix."_games WHERE week = '$weekID'", $dbi);
		while ($row = $db->sql_fetchrow($result_check)) {
			$h = intval($row['home_score']);
			$v = intval($row['visitor_score']);
			$g = intval($row['week']);
			if ($h > 0 || $v >0) { $results_present = 1; }
		}
		if ($results_present == 1) {
			$lrweek = $weekID;
		} else {
			$lrweek = $weekID-1;
		}
		$gameresults = sql_query("SELECT home_score, visitor_score, home_spread, week, game FROM ".$prefix."_games WHERE week <= '$lrweek' ORDER by week, date, game", $dbi);
		while ($row = $db->sql_fetchrow($gameresults)) {
			$total_games++;
			$g_week = intval($row['week']);
			$r_week[$g_week] = $g_week;
			$g_game = intval($row['game']);
			$w_game[$g_week][$g_game] = $g_game;
			$g_home_score = $row['home_score'];
			$g_visitor_score = $row['visitor_score'];
			$g_home_spread = $row['home_spread'];
			if (( $g_home_score > 0 ) or ($g_visitor_score > 0)) {
				$g_result = ($g_home_score - $g_visitor_score) - $g_home_spread;
			} else {
				$g_result = 0;
			}
			if ($g_result > 0) {
				$g_winner[$g_week][$g_game] = "home";
			} elseif ($g_result < 0) {
				$g_winner[$g_week][$g_game] = "visitor";
			} else {
				$g_winner[$g_week][$g_game] = "push";
			}
		}
		asort ($r_week);
		asort ($db_uid);
		foreach ($r_week as $rweek) {
			asort($w_game[$rweek]);
			$maxweek = $rweek;
			foreach ($db_uid as $usernum) {
				if ($usernum == $graphuser) {
					$g_uid = 1;
				} else {
					$g_uid = 2;
				}
				foreach ($w_game[$rweek] as $g_num) {
					if (( $db_pick[$rweek][$usernum][$g_num] == "home" ) || ( $db_pick[$rweek][$usernum][$g_num] == "visitor" )) {
						if ($g_winner[$rweek][$g_num] == $db_pick[$rweek][$usernum][$g_num]) {
							$right[$rweek][$g_uid]++;
						} elseif ($g_winner[$rweek][$g_num] == "push") {
							$push[$rweek][$g_uid]++;
						} else {
							$wrong[$rweek][$g_uid]++;
						}
					}
				}
			}
			if (!($right[$rweek][1])) { $right[$rweek][1] = 0; }
			if (!($wrong[$rweek][1])) { $wrong[$rweek][1] = 0; }
			if (!($right[$rweek][2])) { $right[$rweek][2] = 0; }
			if (!($wrong[$rweek][2])) { $wrong[$rweek][2] = 0; }
			$gindex=$rweek-1;
			if ($right[$rweek][1]+$wrong[$rweek][1] > 0) {
				$ud_pct[$gindex] = number_format( ($right[$rweek][1] / ($right[$rweek][1]+$wrong[$rweek][1])) ,3);
			} else {
				$ud_pct[$gindex] = "-";
			}
			if ($right[$rweek][2]+$wrong[$rweek][2] > 0) {
				$gd_pct[$gindex] = number_format( ($right[$rweek][2] / ($right[$rweek][2]+$wrong[$rweek][2])) ,3);
			} else {
				$gd_pct[$gindex] = 0;
			}
			$gd_week[$gindex] = $rweek;
		}
	} else {
		$boxContent .= "<h4>Nothing to graph.</h4>\n";
	}
	$l1datay = $ud_pct;
	$l2datay = $gd_pct;
	$datax = $gd_week;
	$uname=$db_user[$graphuser];
	$title = $uname."'s pick percentage against the group";
	// Create the graph.
	$graph = new Graph(640,475,"auto");
	$graph->SetBackgroundImage("/usr/local/apache2/pool/images/graphlogo.png",BGIMG_FILLPLOT);
	$graph->AdjBackgroundImage(.8,.8,.8);
	$graph->SetScale("textlin");
	$graph->img->SetMargin(40,20,20,60);
	$graph->yaxis->SetLabelMargin(2);
	$graph->yaxis->SetLabelFormat('%0.3f');
	$graph->yaxis->HideFirstTicklabel();
	$l1plot=new LinePlot($l1datay);
	$l1plot->SetColor("red");
	$l1plot->SetWeight(2);
	$l1plot->SetLegend("$uname");
	$l1plot->mark->SetTYPE(MARK_STAR);
	// Create the bar plot
	$l2plot = new LinePlot($l2datay);
	$l2plot->SetFillColor("#0099ff@0.5");
	$l2plot->SetLegend("everyone else");
	// Add the plots to the graph
	$graph->Add($l2plot);
	$graph->Add($l1plot);	
	$graph->title->Set("$title");
	$graph->xaxis->title->Set("$xtitle");
	$graph->yaxis->title->Set("$ytitle");	
	$graph->title->SetFont(FF_FONT2,FS_BOLD);
	$graph->yaxis->title->SetFont(FF_FONT1,FS_BOLD);
	$graph->xaxis->title->SetFont(FF_FONT1,FS_BOLD);
#	$graph->yaxis->title->Pos(0,0.05,"left","center");
#	$graph->legend->Pos(0.05,0.08,"right","top");
	$graph->legend->SetLayout(LEGEND_HOR);
	$graph->legend->Pos(0.5,0.97,"center","bottom");
	// Display the graph
	$graph->Stroke("/usr/local/apache2/pool/images/graphs/$uname.png");
	$boxContent .= "<img src=\"images/graphs/$uname.png\"><br><br>\n";
}
